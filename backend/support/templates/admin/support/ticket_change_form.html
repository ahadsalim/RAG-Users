{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block content %}
<div id="content-main">
    {% if original %}
        {# نمایش اطلاعات تیکت #}
        <div style="margin-bottom: 30px;">
            {{ adminform.form.ticket_info_display }}
        </div>
        
        {# نمایش اطلاعات زمانی و SLA #}
        <div style="margin-bottom: 30px;">
            {{ adminform.form.time_info_display }}
        </div>
        
        {# نمایش تاریخچه مکالمات #}
        <div style="margin-bottom: 30px;">
            {{ adminform.form.messages_display }}
        </div>
        
        {# فرم پاسخ جدید #}
        <form method="post" id="ticket_form" novalidate>
            {% csrf_token %}
            
            <div style="background: #ffffff; padding: 25px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                <h2 style="margin-top: 0; color: #2c3e50; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">✍️ ارسال پاسخ / پیام جدید</h2>
                
                {% if errors %}
                    <div style="background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <strong>خطا:</strong>
                        {{ errors }}
                    </div>
                {% endif %}
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #374151;">
                        نوع پیام: <span style="color: #ef4444;">*</span>
                    </label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        {% for value, label in adminform.form.message_type.field.choices %}
                        <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" 
                               onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff';" 
                               onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                            <input type="radio" name="message_type" value="{{ value }}" 
                                   {% if adminform.form.message_type.value == value or value == 'reply' and not adminform.form.message_type.value %}checked{% endif %}
                                   onchange="toggleForwardedTo(this.value)"
                                   style="margin-left: 8px;">
                            <span style="font-weight: 500;">{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div style="margin-top: 8px; font-size: 13px; color: #6b7280;">
                        <strong>راهنما:</strong><br>
                        • <strong>پاسخ:</strong> پاسخ به کاربر - وضعیت به "پاسخ داده شده" تغییر می‌کند<br>
                        • <strong>یادداشت داخلی:</strong> فقط برای کارشناسان - وضعیت به "در حال بررسی" تغییر می‌کند<br>
                        • <strong>سوال از کاربر:</strong> سوال از کاربر - وضعیت به "در انتظار پاسخ کاربر" تغییر می‌کند (SLA متوقف می‌شود)<br>
                        • <strong>ارسال به:</strong> ارسال تیکت به کارشناس دیگر - وضعیت به "در حال بررسی" تغییر می‌کند
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;" id="forwarded_to_field" {% if not adminform.form.message_type.value == 'send_to' %}style="display: none;"{% endif %}>
                    <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #374151;">
                        ارسال به کارشناس: <span style="color: #ef4444;">*</span>
                    </label>
                    {{ adminform.form.forwarded_to }}
                    <div style="margin-top: 5px; font-size: 13px; color: #6b7280;">
                        انتخاب کارشناسی که تیکت به او ارسال می‌شود
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #374151;">
                        محتوای پیام: <span style="color: #ef4444;">*</span>
                    </label>
                    {{ adminform.form.content }}
                    <div style="margin-top: 5px; font-size: 13px; color: #6b7280;">
                        متن پیام خود را وارد کنید
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" name="_save" 
                            style="background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 15px;"
                            onmouseover="this.style.background='#2563eb'" 
                            onmouseout="this.style.background='#3b82f6'">
                        ✉️ ارسال پیام
                    </button>
                    <a href="{% url 'admin:support_ticket_changelist' %}" 
                       style="background: #6b7280; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 600; text-decoration: none; display: inline-block;"
                       onmouseover="this.style.background='#4b5563'" 
                       onmouseout="this.style.background='#6b7280'">
                        بازگشت به لیست
                    </a>
                </div>
            </div>
        </form>
        
        <script>
        function toggleForwardedTo(messageType) {
            var field = document.getElementById('forwarded_to_field');
            if (messageType === 'send_to') {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        }
        
        // اجرای اولیه
        document.addEventListener('DOMContentLoaded', function() {
            var selectedType = document.querySelector('input[name="message_type"]:checked');
            if (selectedType) {
                toggleForwardedTo(selectedType.value);
            }
        });
        </script>
    {% else %}
        {# فرم ایجاد تیکت جدید (اگر نیاز باشد) #}
        {{ block.super }}
    {% endif %}
</div>
{% endblock %}
