{% load i18n static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورود به پنل مدیریت</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Tahoma, Arial, sans-serif; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 480px;
            padding: 30px;
        }
        .login-title {
            text-align: center;
            margin-bottom: 24px;
            color: #333;
            font-size: 18px;
        }
        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 14px;
            align-items: center;
        }
        .form-row label {
            min-width: 90px;
            color: #555;
            font-size: 13px;
        }
        .form-row input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            direction: ltr;
        }
        .form-row input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5a6fd6; }
        .btn-otp { background: #11998e; color: white; }
        .btn-otp:hover:not(:disabled) { background: #0d7d74; }
        .msg {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 14px;
            font-size: 12px;
            text-align: center;
        }
        .msg-error { background: #fee2e2; color: #dc2626; }
        .msg-success { background: #d1fae5; color: #059669; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="login-box">
        <div class="login-title">ورود به پنل مدیریت</div>
        
        <div id="msg-box" class="msg hidden"></div>
        
        <form id="login-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="step" id="step-input" value="login">
            <input type="hidden" name="otp_mode" id="otp-mode" value="0">
            
            <div class="form-row">
                <label>شماره موبایل</label>
                <input type="tel" id="phone" name="phone_number" 
                       placeholder="09121234567" maxlength="11"
                       value="{{ phone_number|default:'' }}">
            </div>
            
            <div class="form-row" id="otp-row" style="display: none;">
                <label id="pass-label">رمز یکبارمصرف</label>
                <input type="text" id="pass" name="password" placeholder="کد 5 رقمی" maxlength="5">
            </div>
            
            <div class="btn-row">
                <button type="button" id="btn-sms" class="btn btn-otp" onclick="handleOTP('sms')" style="flex: 1;">ارسال رمز با پیامک</button>
                <button type="button" id="btn-bale" class="btn btn-primary" onclick="handleOTP('bale')" style="flex: 1;">ارسال رمز در بله</button>
            </div>
        </form>
    </div>
    
    <script>
        const csrf = '{{ csrf_token }}';
        let otpMode = false;
        let cooldown = 0;
        
        function showMsg(text, isError) {
            const box = document.getElementById('msg-box');
            box.textContent = text;
            box.className = 'msg ' + (isError ? 'msg-error' : 'msg-success');
            box.classList.remove('hidden');
        }
        
        function handleOTP(method) {
            const phone = document.getElementById('phone').value.trim();
            const btnSms = document.getElementById('btn-sms');
            const btnBale = document.getElementById('btn-bale');
            const btn = method === 'sms' ? btnSms : btnBale;
            
            if (!phone || phone.length < 10) {
                showMsg('شماره موبایل معتبر وارد کنید', true);
                return;
            }
            
            if (otpMode) {
                const pass = document.getElementById('pass').value.trim();
                if (!pass || pass.length !== 5) {
                    showMsg('کد 5 رقمی را وارد کنید', true);
                    return;
                }
                document.getElementById('step-input').value = 'verify_otp';
                document.getElementById('otp-mode').value = '1';
                document.getElementById('login-form').submit();
                return;
            }
            
            if (cooldown > 0) {
                showMsg(cooldown + ' ثانیه صبر کنید', true);
                return;
            }
            
            btnSms.disabled = true;
            btnBale.disabled = true;
            btn.textContent = 'در حال ارسال...';
            
            fetch('', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrf },
                body: 'step=send_otp&phone_number=' + encodeURIComponent(phone) + '&delivery_method=' + method
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    showMsg(data.message || 'کد ارسال شد', false);
                    otpMode = true;
                    document.getElementById('otp-row').style.display = 'flex';
                    document.getElementById('pass').value = '';
                    document.getElementById('pass').focus();
                    btnSms.textContent = 'ورود';
                    btnBale.textContent = 'ورود';
                    btnSms.disabled = false;
                    btnBale.disabled = false;
                    btnSms.onclick = function() { handleOTP('verify'); };
                    btnBale.onclick = function() { handleOTP('verify'); };
                    startCooldown(120);
                } else {
                    showMsg(data.error || 'خطا', true);
                    btnSms.textContent = 'ارسال رمز با پیامک';
                    btnBale.textContent = 'ارسال رمز در بله';
                    btnSms.disabled = false;
                    btnBale.disabled = false;
                }
            })
            .catch(function() {
                showMsg('خطا در ارتباط', true);
                btn.textContent = 'ارسال رمز یکبارمصرف';
                btn.disabled = false;
            });
        }
        
        function startCooldown(sec) {
            cooldown = sec;
            var interval = setInterval(function() {
                cooldown--;
                if (cooldown <= 0) clearInterval(interval);
            }, 1000);
        }
        
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
        });
        
        document.getElementById('phone').focus();
        
        {% if error %}showMsg('{{ error|escapejs }}', true);{% endif %}
        {% if message %}showMsg('{{ message|escapejs }}', false);{% endif %}
        {% if otp_sent %}
        otpMode = true;
        document.getElementById('otp-row').style.display = 'flex';
        document.getElementById('btn-otp').textContent = 'ورود';
        {% endif %}
    </script>
</body>
</html>
