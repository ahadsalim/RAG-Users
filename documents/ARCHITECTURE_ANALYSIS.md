# ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ùˆ Ù¾Ø§Ø³Ø® Ø³ÙˆØ§Ù„Ø§Øª

## 1ï¸âƒ£ ØªÙ†Ø¸ÛŒÙ…Ø§Øª LLM - Ú©Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯ØŸ

### ğŸ”¹ Ù…Ø¹Ù…Ø§Ø±ÛŒ ÙØ¹Ù„ÛŒ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Users System                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Frontend UI   â”‚ â”€â”€â”€â”€â”€â”€> â”‚   Backend      â”‚              â”‚
â”‚  â”‚  (React/Next)  â”‚         â”‚   (Django)     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚ JWT Token
                                        â”‚ Query + Params
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Core System                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Core API      â”‚â”€â”€â”€>â”‚  RAG       â”‚â”€â”€â”€>â”‚  LLM (GPT-4)  â”‚ â”‚
â”‚  â”‚  (FastAPI)     â”‚    â”‚  Pipeline  â”‚    â”‚  + Embeddings â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                                                   â”‚
â”‚          â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚  Qdrant        â”‚  (Vector Database)                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âœ… Ù¾Ø§Ø³Ø®: ØªÙ†Ø¸ÛŒÙ…Ø§Øª LLM Ø¯Ø± Ú©Ø¬Ø§ØŸ

#### ğŸ“ **Ø³Ø·Ø­ 1: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Per-Request (Users System)**

Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª LLM Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:

```python
# Ø¯Ø± Users System - core_service.py
async def send_query(
    self,
    query: str,
    token: str,
    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª LLM Ú©Ù‡ Ø¨Ù‡ Core Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯:
    temperature: float = 0.7,        # 0.0 - 2.0 (Ø®Ù„Ø§Ù‚ÛŒØª)
    max_tokens: int = 4096,          # Ø­Ø¯Ø§Ú©Ø«Ø± Ø·ÙˆÙ„ Ù¾Ø§Ø³Ø®
    top_p: float = 0.9,              # nucleus sampling
    frequency_penalty: float = 0.0,  # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø±
    presence_penalty: float = 0.0,   # ØªÙ†ÙˆØ¹ Ù…ÙˆØ¶ÙˆØ¹ÛŒ
    ...
):
    payload = {
        "query": query,
        "temperature": temperature,
        "max_tokens": max_tokens,
        "top_p": top_p,
        "frequency_penalty": frequency_penalty,
        "presence_penalty": presence_penalty,
    }
```

**Ù…Ø²Ø§ÛŒØ§:**
- âœ… Ú©Ù†ØªØ±Ù„ Ú©Ø§Ù…Ù„ Ø¯Ø± Ø³Ù…Øª Frontend
- âœ… Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ… ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±
- âœ… Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø±Ø§ÛŒ Ù‡Ø± query ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…ØªÙØ§ÙˆØª Ø¯Ø§Ø´Øª

**Ù…Ø¹Ø§ÛŒØ¨:**
- âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ UI Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
- âš ï¸ Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨

---

#### ğŸ“ **Ø³Ø·Ø­ 2: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Per-Conversation (Users System)**

ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø§ÛŒØ¬Ø§Ø¯ conversation Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:

```python
# API: POST /api/v1/users/conversations
{
  "title": "Ø³ÙˆØ§Ù„ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù‚Ø§Ù†ÙˆÙ† Ú©Ø§Ø±",
  "context": {
    "topic": "labor_law",
    "preferences": {
      "detail_level": "comprehensive"
    }
  },
  "llm_model": "gpt-4-turbo",      # Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„
  "temperature": 0.7,               # ØªÙ†Ø¸ÛŒÙ…Ø§Øª LLM
  "max_tokens": 4096
}
```

**Ù…Ø²Ø§ÛŒØ§:**
- âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… conversation Ø«Ø§Ø¨Øª Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
- âœ… Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø§Ø² Per-Request

---

#### ğŸ“ **Ø³Ø·Ø­ 3: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Global (Core System)**

ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± Core System:

```python
# Ø¯Ø± Core System - config.py
LLM_SETTINGS = {
    "model": "gpt-4-turbo",
    "temperature": 0.7,
    "max_tokens": 4096,
    "system_prompt": "Ø´Ù…Ø§ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ø­Ù‚ÙˆÙ‚ÛŒ Ù‡Ø³ØªÛŒØ¯...",
}
```

**Ù…Ø²Ø§ÛŒØ§:**
- âœ… ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
- âœ… Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªÙ…Ø±Ú©Ø²

**Ù…Ø¹Ø§ÛŒØ¨:**
- âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Core System
- âš ï¸ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† per-user ØªÙ†Ø¸ÛŒÙ… Ú©Ø±Ø¯

---

### ğŸ¯ ØªÙˆØµÛŒÙ‡:

#### **ØªØ±Ú©ÛŒØ¨ Ø³Ø·Ø­ 1 + 2:**

1. **Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± Frontend:**
```typescript
// Frontend - defaultLLMSettings.ts
export const defaultLLMSettings = {
  temperature: 0.7,
  max_tokens: 2000,
  model: 'gpt-4-turbo',
};

// Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø¹Ø§Ø¯ÛŒ
const normalQuery = {
  ...defaultLLMSettings,
  temperature: 0.7, // Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø§Ø¯Ù„
};

// Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚
const preciseQuery = {
  ...defaultLLMSettings,
  temperature: 0.3, // Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±
  max_tokens: 4000,
};

// Ø¨Ø±Ø§ÛŒ Ø®Ù„Ø§Ù‚ÛŒØª
const creativeQuery = {
  ...defaultLLMSettings,
  temperature: 1.2, // Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡â€ŒØªØ±
};
```

2. **Ø§Ø±Ø³Ø§Ù„ Ø¯Ø± Query:**
```python
# Backend - consumers.py
async def handle_query(self, data):
    # Ø¯Ø±ÛŒØ§ÙØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² frontend
    llm_settings = data.get('llm_settings', {})
    
    response = await core_service.send_query(
        query=query,
        token=self.jwt_token,
        temperature=llm_settings.get('temperature', 0.7),
        max_tokens=llm_settings.get('max_tokens', 2000),
        # ...
    )
```

---

## 2ï¸âƒ£ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú†Øª - Ú©Ø¯Ø§Ù… Ø³ÛŒØ³ØªÙ…ØŸ

### ğŸ“Š ØªÙˆØ²ÛŒØ¹ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Users System (Django)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (User, Profile, Organization)               â”‚
â”‚ âœ… Conversations (metadata Ù…Ø­Ù„ÛŒ + rag_conversation_id)          â”‚
â”‚ âœ… Messages (cache Ù…Ø­Ù„ÛŒ + rag_message_id)                       â”‚
â”‚ âœ… UI State (pinned, archived, folders)                          â”‚
â”‚ âœ… Permissions & Access Control                                  â”‚
â”‚ âœ… Subscription & Payment                                        â”‚
â”‚ âœ… Local Analytics & Logs                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Sync via API
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Core System (FastAPI)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Conversations (master data)                                   â”‚
â”‚ âœ… Messages (master data + RAG context)                          â”‚
â”‚ âœ… User Query History                                            â”‚
â”‚ âœ… Usage Statistics (tokens, queries)                            â”‚
â”‚ âœ… Document Embeddings (Qdrant)                                  â”‚
â”‚ âœ… RAG Processing History                                        â”‚
â”‚ âœ… LLM Responses & Sources                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ—‚ï¸ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ:

| Ø¯Ø§Ø¯Ù‡ | Users System | Core System | Master |
|------|-------------|-------------|---------|
| **Ú©Ø§Ø±Ø¨Ø±Ø§Ù†** | | | |
| User Profile | âœ… Full | âœ… External ID | Users |
| Email/Password | âœ… | âŒ | Users |
| Subscription | âœ… | âœ… Tier only | Users |
| Permissions | âœ… | âŒ | Users |
| | | | |
| **Ù…Ú©Ø§Ù„Ù…Ø§Øª** | | | |
| Conversation Metadata | âœ… Full | âœ… Full | **Both** |
| Title/Description | âœ… | âœ… | Core |
| UI State (pinned, etc) | âœ… | âŒ | Users |
| Folder Organization | âœ… | âŒ | Users |
| | | | |
| **Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§** | | | |
| Message Content | âœ… Cache | âœ… Full | Core |
| User Query | âœ… | âœ… | Core |
| AI Response | âœ… | âœ… | Core |
| Sources/Citations | âœ… | âœ… | Core |
| RAG Context | âŒ | âœ… | Core |
| Embeddings | âŒ | âœ… (Qdrant) | Core |
| | | | |
| **Ø¢Ù…Ø§Ø±** | | | |
| Message Count | âœ… | âœ… | **Both** |
| Token Usage | âœ… | âœ… | Core |
| Daily Queries | âŒ | âœ… | Core |
| Response Time | âŒ | âœ… | Core |

---

### ğŸ”„ Ø§Ù„Ú¯ÙˆÛŒ Sync:

```python
# Ù…Ø«Ø§Ù„: Ø§ÛŒØ¬Ø§Ø¯ Message
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Frontend Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯                                   â”‚
â”‚    POST ws://backend/chat                                   â”‚
â”‚    {"action": "query", "message": "Ù‚Ø§Ù†ÙˆÙ† Ú©Ø§Ø± Ú†ÛŒØ³ØªØŸ"}       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Users Backend                                            â”‚
â”‚    - Ø§ÛŒØ¬Ø§Ø¯ Message Ø¯Ø± DB Ù…Ø­Ù„ÛŒ (status=processing)         â”‚
â”‚    - Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Core                                         â”‚
â”‚      message_local = Message.objects.create(...)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Core System                                              â”‚
â”‚    - Ù¾Ø±Ø¯Ø§Ø²Ø´ RAG                                            â”‚
â”‚    - Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± DB Core                                      â”‚
â”‚    - Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† response + message_id                       â”‚
â”‚      conversation_id, message_id, answer, sources           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Users Backend                                            â”‚
â”‚    - Ø¢Ù¾Ø¯ÛŒØª Message Ù…Ø­Ù„ÛŒ                                    â”‚
â”‚      message_local.rag_message_id = message_id              â”‚
â”‚      message_local.rag_conversation_id = conversation_id    â”‚
â”‚      message_local.status = 'completed'                     â”‚
â”‚    - Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Frontend                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3ï¸âƒ£ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† - Sync Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ

### ğŸ”„ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Sync Strategy                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Users System (Source of Truth for Users)                    â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”‚ On First Query                                     â”‚
â”‚         â”œâ”€â”€> JWT Token with user info                        â”‚
â”‚         â”‚    (sub, username, email, tier)                    â”‚
â”‚         â”‚                                                     â”‚
â”‚         â–¼                                                     â”‚
â”‚  Core System                                                  â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â”€> Auto-create user if not exists                  â”‚
â”‚         â”œâ”€â”€> Update tier if changed                          â”‚
â”‚         â””â”€â”€> Track queries & usage                           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âœ… Ø¢Ù†Ú†Ù‡ Sync Ù…ÛŒâ€ŒØ´ÙˆØ¯:

#### 1. **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± (Auto-sync via JWT)**

```python
# Ù‡Ø± Ø¨Ø§Ø± Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± query Ù…ÛŒâ€ŒÙØ±Ø³ØªØ¯:
JWT Token = {
    "sub": "user-uuid",
    "username": "ahmad123",
    "email": "ahmad@example.com",
    "tier": "premium"  # â† Ø§ÛŒÙ† Ù‡Ø± Ø¨Ø§Ø± sync Ù…ÛŒâ€ŒØ´ÙˆØ¯
}

# Core System:
# - Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª â†’ Ø§ÛŒØ¬Ø§Ø¯
# - Ø§Ú¯Ø± tier ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ â†’ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
# - Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ last_active_at
```

#### 2. **Conversations (Real-time sync)**

```python
# Users System â”€â”€â”€â”€â”€> Core System
Conversation.rag_conversation_id  â†â”€â”€â”€â”€â”€â”€â”
                                          â”‚ Linked
Message.rag_message_id  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ù‡Ø± Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯:**
- âœ… Ø¯Ø± Users Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
- âœ… Ø¨Ù‡ Core Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
- âœ… Core ÛŒÚ© `conversation_id` Ùˆ `message_id` Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
- âœ… Users Ø§ÛŒÙ† IDÙ‡Ø§ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯

#### 3. **Usage Statistics (One-way: Core â†’ Users)**

```python
# Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Core Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯:
GET /api/v1/users/statistics

Response:
{
    "total_queries": 150,
    "daily_queries": 10,
    "daily_limit": 50,
    "total_tokens": 25000
}

# Ùˆ Ø¯Ø± Users Cache Ú©Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø³Ø±ÛŒØ¹â€ŒØªØ±
```

---

### âš ï¸ Ø¢Ù†Ú†Ù‡ Sync Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯:

| Ø¯Ø§Ø¯Ù‡ | Ú†Ø±Ø§ØŸ |
|------|------|
| Password | Ø§Ù…Ù†ÛŒØª - ÙÙ‚Ø· Ø¯Ø± Users |
| Payment Info | Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ - ÙÙ‚Ø· Ø¯Ø± Users |
| Organizations | Ù…Ù†Ø·Ù‚ Business - ÙÙ‚Ø· Ø¯Ø± Users |
| UI Preferences | Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Frontend - ÙÙ‚Ø· Ø¯Ø± Users |
| Folders | Ø³Ø§Ø²Ù…Ø§Ù†Ø¯Ù‡ÛŒ Ù…Ø­Ù„ÛŒ - ÙÙ‚Ø· Ø¯Ø± Users |

---

### ğŸ¯ ØªÙˆØµÛŒÙ‡: Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Sync Ø¨Ù‡ØªØ±

```python
# ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯: /srv/backend/chat/sync.py

class CoreSyncService:
    """Ø³Ø±ÙˆÛŒØ³ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Core System"""
    
    async def sync_user_profile(self, user):
        """
        Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Core
        ÙÙ‚Ø· Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ tier ØªØºÛŒÛŒØ± Ú©Ù†Ø¯
        """
        # Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ø² Core
        profile = await core_service.get_user_profile(token)
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
        if profile['tier'] != user.subscription.tier:
            # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ tier Ø¯Ø± Core
            await core_service.update_user_profile(
                token=token,
                tier=user.subscription.tier
            )
    
    async def sync_conversations(self, user):
        """
        Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª conversations
        Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
        """
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Core
        core_convs = await core_service.get_conversations(token)
        
        # Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ù…Ø­Ù„ÛŒ
        local_convs = await self.get_local_conversations(user)
        
        # Sync missing ones
        # ...
    
    async def periodic_sync(self):
        """
        Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ (Ù…Ø«Ù„Ø§Ù‹ Ù‡Ø± 1 Ø³Ø§Ø¹Øª)
        """
        # Sync usage statistics
        # Sync conversation metadata
        # Clean up old cache
        pass
```

---

## ğŸ“‹ Ø®Ù„Ø§ØµÙ‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§:

### 1ï¸âƒ£ ØªÙ†Ø¸ÛŒÙ…Ø§Øª LLM:
- âœ… **ØªÙˆØµÛŒÙ‡:** ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± Frontend
- âœ… Ø§Ø±Ø³Ø§Ù„ per-query Ø¨Ù‡ Core
- âœ… Ø§Ù…Ú©Ø§Ù† ØªÙ†Ø¸ÛŒÙ… ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± UI

### 2ï¸âƒ£ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:
- âœ… **Users System:** User data + UI state + local cache
- âœ… **Core System:** Conversations + Messages + RAG data + Statistics
- âœ… **Master:** Core Ø¨Ø±Ø§ÛŒ content, Users Ø¨Ø±Ø§ÛŒ users

### 3ï¸âƒ£ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ:
- âœ… **Auto-sync:** User info via JWT (Ù‡Ø± query)
- âœ… **Real-time:** Conversations & Messages
- âœ… **On-demand:** Statistics & usage data
- âš ï¸ **No sync:** Passwords, payments, UI prefs

---

## ğŸš€ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ù‡Ø¨ÙˆØ¯:

### Priority 1:
1. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ LLM Ø¨Ù‡ `core_service.send_query()`
2. Ø§ÛŒØ¬Ø§Ø¯ UI Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª LLM Ø¯Ø± Frontend
3. Cache Ú©Ø±Ø¯Ù† statistics Ø¯Ø± Users System

### Priority 2:
4. Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ `CoreSyncService` Ø¨Ø±Ø§ÛŒ sync Ø¨Ù‡ØªØ±
5. Periodic sync job Ø¨Ø§ Celery
6. Webhook Ø§Ø² Core Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±Ø§Øª real-time

### Priority 3:
7. Monitoring Ø¨Ø±Ø§ÛŒ ØªØ§Ø®ÛŒØ±Ù‡Ø§ÛŒ sync
8. Conflict resolution strategy
9. Backup & restore Ø§Ø² Core
